<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="E-COM 4- Credential based and token based authentication" /><meta name="author" content="Silesh Chandran" /><meta property="og:locale" content="en_US" /><meta name="description" content="Before we delve into adding more complex features, it would be better to add some other core necessities that a server needs. I’m referring to user authentication. Currently all of the APIs can be used by anyone, this should not be the case and we should ideally authenticate users and allow operations only post that. We’ll start by making some changes to the user schema and then authenticating and whitelisting some requests. First we will look at authenticating each request with credentials and then switch to authenticating once and using a token subsequently." /><meta property="og:description" content="Before we delve into adding more complex features, it would be better to add some other core necessities that a server needs. I’m referring to user authentication. Currently all of the APIs can be used by anyone, this should not be the case and we should ideally authenticate users and allow operations only post that. We’ll start by making some changes to the user schema and then authenticating and whitelisting some requests. First we will look at authenticating each request with credentials and then switch to authenticating once and using a token subsequently." /><link rel="canonical" href="https://silesh.com/posts/ecom4-auth/" /><meta property="og:url" content="https://silesh.com/posts/ecom4-auth/" /><meta property="og:site_name" content="Silesh.com" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-08-07T22:40:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="E-COM 4- Credential based and token based authentication" /><meta name="twitter:site" content="@god_of_dummies" /><meta name="twitter:creator" content="@Silesh Chandran" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Silesh Chandran"},"description":"Before we delve into adding more complex features, it would be better to add some other core necessities that a server needs. I’m referring to user authentication. Currently all of the APIs can be used by anyone, this should not be the case and we should ideally authenticate users and allow operations only post that. We’ll start by making some changes to the user schema and then authenticating and whitelisting some requests. First we will look at authenticating each request with credentials and then switch to authenticating once and using a token subsequently.","url":"https://silesh.com/posts/ecom4-auth/","@type":"BlogPosting","headline":"E-COM 4- Credential based and token based authentication","dateModified":"2021-08-07T22:40:00+08:00","datePublished":"2021-08-07T22:40:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://silesh.com/posts/ecom4-auth/"},"@context":"https://schema.org"}</script><title>E-COM 4- Credential based and token based authentication | Silesh.com</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://ik.imagekit.io/caveman96/assets/img/ai_Y1y5Y2Nq-4I.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Silesh.com</a></div><div class="site-subtitle font-italic">The Caveman Blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/caveman96" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/god_of_dummies" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['silesh.c','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="https://linkedin.com/in/silesh" aria-label="linkedin" class="order-6" > <i class="fab fa-linkedin"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>E-COM 4- Credential based and token based authentication</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>E-COM 4- Credential based and token based authentication</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Silesh Chandran </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Aug 7, 2021, 10:40 PM +0800" prep="on" > Aug 7 <i class="unloaded">2021-08-07T22:40:00+08:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2143 words">11 min</span></div></div><div class="post-content"><p>Before we delve into adding more complex features, it would be better to add some other core necessities that a server needs. I’m referring to user authentication. Currently all of the APIs can be used by anyone, this should not be the case and we should ideally authenticate users and allow operations only post that. We’ll start by making some changes to the user schema and then authenticating and whitelisting some requests. First we will look at authenticating each request with credentials and then switch to authenticating once and using a token subsequently.</p><h2 id="credential-based-authentication">Credential based authentication</h2><p>The simplest form of authentication we can add to our server is by using credentials directly to verify each request. This would involve comparing the incoming username/password fields directly to the ones stored in the db. First lets add a password field to the user schema:</p><h4 id="usermodeljs">user.model.js</h4><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">userSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Schema</span><span class="p">({</span>
    <span class="na">name</span> <span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span>
    <span class="na">email</span> <span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">unique</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">trim</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">minlength</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
    <span class="na">password</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">minlength</span><span class="p">:</span> <span class="mi">6</span><span class="p">}</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="na">timestamps</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="p">});</span>
</pre></table></code></div></div><p>Now what we need to do is to verify this password in every request that comes to the server. Express provides an easy way to do this using middleware functions. A middleware function is simply a function that has access to the request object and the response object. We can simply define an auth method and use it as an application level middleware, this will be executed with each request. Lets create a method in a new file called auth.js, and use this in server.js.</p><p>Since we are using postman, we can use the basic auth configuration from postman. This takes a username and password, concatnates them to a string like <code class="language-plaintext highlighter-rouge">username:password</code> and then base64 encodes it. This is then stored under the <code class="language-plaintext highlighter-rouge">authorization</code> header in the format <code class="language-plaintext highlighter-rouge">Bearer &lt;value&gt;</code>. So we have to split it, decode it and split it again to get the username and password.</p><h4 id="authjs">auth.js</h4><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre><span class="kd">let</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../models/user.model</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">whitelist</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">]</span>

<span class="c1">//Method for reading the request object</span>
<span class="kd">const</span> <span class="nx">doAuth</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">whitelist</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">originalUrl</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">next</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">authorization</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1"> </span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="dl">'</span><span class="s1">base64</span><span class="dl">'</span><span class="p">).</span><span class="nx">toString</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">authorization</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="kd">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">authorization</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">//find one user that matches the email id</span>
        <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">:</span> <span class="nx">email</span> <span class="p">})</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="c1">//if no entry was found that means the email was not in db</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
                        <span class="na">error</span><span class="p">:</span> <span class="p">{</span>
                            <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">user not registered</span><span class="dl">'</span>
                        <span class="p">}</span>
                    <span class="p">});</span>
                <span class="p">}</span>
                <span class="c1">//if passwords match proceed to the next method, which will call the correct router for the api path</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">===</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">next</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">//if passwords dont match responsd with 403</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
                        <span class="na">error</span><span class="p">:</span> <span class="p">{</span>
                            <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">password incorrect</span><span class="dl">'</span>
                        <span class="p">}</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
                <span class="na">error</span><span class="p">:</span> <span class="p">{</span>
                    <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Auth Failed db error: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">err</span>
                <span class="p">}</span>
            <span class="p">}));</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//catch the errors that occur during parsing the authorization header</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
            <span class="na">error</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">authorization invalid</span><span class="dl">"</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//export the method so it can be used</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">doAuth</span><span class="p">;</span>
</pre></table></code></div></div><p>We should add the password to our users post API:</p><h4 id="usersjs">users.js</h4><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nx">router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">).</span><span class="nx">post</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">//get name and email from payload</span>
    <span class="p">({</span><span class="nx">name</span><span class="p">,</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span><span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
    <span class="c1">//create new user object</span>
    <span class="kd">const</span> <span class="nx">newUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">({</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="nx">name</span><span class="p">,</span> <span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">:</span> <span class="nx">email</span><span class="p">,</span> <span class="dl">"</span><span class="s2">password</span><span class="dl">"</span><span class="p">:</span> <span class="nx">password</span><span class="p">});</span>
	   
	<span class="nx">newUser</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="dl">'</span><span class="s1">user added successfully</span><span class="dl">'</span><span class="p">))</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="dl">'</span><span class="s1">error: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">err</span><span class="p">));</span>

	<span class="p">});</span>

</pre></table></code></div></div><p>The middleware is simply used in the main server.js by doing <code class="language-plaintext highlighter-rouge">app.use(method)</code>. This ensures that any request coming to the server first passes through the middleware and then from there it is forwarded to the right place by the <code class="language-plaintext highlighter-rouge">next</code> method. We can also make this specific to certain endpoints like <code class="language-plaintext highlighter-rouge">app.use('/test', method)</code>. This way only the requests that match the path are going to go through the middleware.</p><h4 id="serverjs">server.js</h4><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">auth</span><span class="dl">'</span><span class="p">);</span>
<span class="c1">//Use auth method as the middleware to do authentication</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">auth</span><span class="p">);</span>
</pre></table></code></div></div><p>Lets create some new Users that have the password field and then lets use their credentials to access the products list. Trying with no credentials enters the outer catch block and throws one error: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://ik.imagekit.io/caveman96/assets/img/ECOM/products-invalid_rFWcrX15c84m.png" alt="Desktop View" /> <em>with invalid credentials</em></p><p>Doing the same with an invalid email throws a different error: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://ik.imagekit.io/caveman96/assets/img/ECOM/products-notfound_8tHBoizGC5.png" alt="Desktop View" /> <em>with incorrect email</em></p><p>And finally trying to do the same with the correct credentials gets us the product list: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://ik.imagekit.io/caveman96/assets/img/ECOM/products-valid_sfSzIbDBSNFn.png" alt="Desktop View" /> <em>Post the product details</em></p><h2 id="token-based-authentication">Token based authentication</h2><p>It can be clearly seen how using credentials for every single api call can carry a big risk with it. In an actual working environment, the user enters his password once to log in from the browser. Now if the password is needed for each subsequent request, the browser will have to save the password in memory which is a massive security risk. The ideal scenario would be something that allows the user to log in with his credentials once and then make each request with some sort of a shared access key which can be validated by the server to provide access. This way rather than sending the password with each request, which is a secret that doesnt change often and so is more sensitive, we can instead use a time limited token.</p><p>For now this can be accomplished by generating a random string which can be stored in the db along with an expiry timestamp. This string can be sent to the user and used as a token subsequently. To ensure uniqueness we can include a timestamp component while generating the string, so something like 5 random characters and the timestamp which are then base64 encoded can be used. When a request is made with the token, we will have to validate the token by checking against the db, and we will also have to verify that the token is not expired. If it is expired then a new token needs to be generated.</p><p>The basic workflow can be seen with a sequence diagram:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://ik.imagekit.io/caveman96/assets/img/ECOM/tokenflow_G1fzn8CiYNt.png" alt="Desktop View" /> <em>workflow sequence</em></p><p>To get started lets create a new schema where the auth token and its timestamp will be saved.</p><h4 id="tokenmodeljs">token.model.js</h4><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">mongoose</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">Schema</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">tokenSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Schema</span><span class="p">({</span>
    <span class="na">expiry</span> <span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">Number</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span>
    <span class="na">token</span> <span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">unique</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">trim</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="na">timestamps</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">Token</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="dl">'</span><span class="s1">Token</span><span class="dl">'</span><span class="p">,</span> <span class="nx">tokenSchema</span><span class="p">);</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Token</span><span class="p">;</span>

</pre></table></code></div></div><p>So we have 2 fields, token and expiry. When we create a token we will add it along with an expiry. When a token is used we will compare the current timestamp with the expiry to verify if the token is still valid. A new route and service for generating the token also needs to be created:</p><h4 id="authjs-1">auth.js</h4><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre>
<span class="c1">//Method for creating an access token</span>
<span class="kd">const</span> <span class="nx">createToken</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">authorization</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1"> </span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="dl">'</span><span class="s1">base64</span><span class="dl">'</span><span class="p">).</span><span class="nx">toString</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">authorization</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="kd">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">authorization</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">//find one user that matches the email id</span>
        <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">:</span> <span class="nx">email</span> <span class="p">})</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="c1">//if no entry was found that means the email was not in db</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
                        <span class="na">error</span><span class="p">:</span> <span class="p">{</span>
                            <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">user not registered</span><span class="dl">'</span>
                        <span class="p">}</span>
                    <span class="p">});</span>
                <span class="p">}</span>
                <span class="c1">//if passwords match proceed to the next method, which will call the correct router for the api path</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">===</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">//get current date and time in milliseconds</span>
                    <span class="kd">const</span> <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
                    <span class="kd">const</span> <span class="nx">nowinMillis</span> <span class="o">=</span> <span class="nx">now</span><span class="p">.</span><span class="nx">getTime</span><span class="p">();</span>
                    <span class="c1">//create a random string of length 5</span>
                    <span class="kd">const</span> <span class="nx">randomString</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">);</span>
                    <span class="c1">//base64 encode the random+time string</span>
                    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">randomString</span><span class="o">+</span><span class="nx">nowinMillis</span><span class="p">.</span><span class="nx">toString</span><span class="p">()).</span><span class="nx">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">base64</span><span class="dl">'</span><span class="p">);</span>
                    <span class="kd">const</span> <span class="nx">expiry</span> <span class="o">=</span> <span class="nx">now</span><span class="o">+</span><span class="mi">60000</span> <span class="c1">//60 seconds</span>
                    <span class="c1">//create a new token object with expiry</span>
                    <span class="kd">const</span> <span class="nx">newToken</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Token</span><span class="p">({</span><span class="dl">"</span><span class="s2">token</span><span class="dl">"</span><span class="p">:</span> <span class="nx">token</span><span class="p">,</span> <span class="dl">"</span><span class="s2">expiry</span><span class="dl">"</span><span class="p">:</span> <span class="nx">expiry</span><span class="p">});</span>
                    <span class="c1">//save new user object</span>
                    <span class="nx">newToken</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
                        <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
                            <span class="dl">"</span><span class="s2">token</span><span class="dl">"</span><span class="p">:</span> <span class="nx">token</span>
                        <span class="p">}))</span>
                        <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span><span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="dl">'</span><span class="s1">error: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">err</span><span class="p">));</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">//if passwords dont match responsd with 403</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
                        <span class="na">error</span><span class="p">:</span> <span class="p">{</span>
                            <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">password incorrect</span><span class="dl">'</span>
                        <span class="p">}</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
                <span class="na">error</span><span class="p">:</span> <span class="p">{</span>
                    <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Auth Failed db error: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">err</span>
                <span class="p">}</span>
            <span class="p">}));</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//catch the errors that occur during parsing the authorization header</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
            <span class="na">error</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">authorization invalid</span><span class="dl">"</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c1">//export the method so it can be used</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span><span class="nx">doAuth</span><span class="p">,</span> <span class="nx">createToken</span><span class="p">};</span>
</pre></table></code></div></div><p>This is mostly exactly the same code as the credential verification that we saw earlier. The only difference is that now, we create a new token object and save that in db. This is then returned back in the response as well. The generation of random string component was done by <code class="language-plaintext highlighter-rouge">Math.random().toString(36).substring(2,7)</code>. This is quite interestinhg in the way it works:</p><p><code class="language-plaintext highlighter-rouge">Math.random()</code> generates a random decimal between 0 and 1, <code class="language-plaintext highlighter-rouge">0.6166062056552559</code> for example. A <code class="language-plaintext highlighter-rouge">number.toString()</code> method takes an argument between 2 and 36, which tells what base to convert it to. 2 is binary, 16 is hex and 36 is [0-9a-z]. So doing <code class="language-plaintext highlighter-rouge">0.6166062056552559.toString(36)</code> gives us <code class="language-plaintext highlighter-rouge">"0.m74dncqkw7"</code>. We just need to do substring between 2 and 7 to get 5 characters <code class="language-plaintext highlighter-rouge">m74dn</code>.</p><p>Now that we have a way to generate a token, lets also use it. We can modify the current middleware doAuth method which takes username and password to instead find the token in the db. If a token is found and it is within its expiry, then we continue, otherwise we delete the token from db and respond with error.</p><h4 id="authjs-2">auth.js</h4><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre><td class="rouge-code"><pre><span class="c1">//add token endpoint also to the whitelist</span>
<span class="kd">const</span> <span class="nx">whitelist</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/token</span><span class="dl">'</span><span class="p">]</span>
<span class="p">...</span>

<span class="c1">//Method for reading the request object and verifying token</span>
<span class="kd">const</span> <span class="nx">doAuth</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">whitelist</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">originalUrl</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="c1">//token is send as authorization: Bearer &lt;token&gt;</span>
        <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1"> </span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
        <span class="c1">//get current date and time in milliseconds</span>
        <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
        <span class="nx">nowinMillis</span> <span class="o">=</span> <span class="nx">now</span><span class="p">.</span><span class="nx">getTime</span><span class="p">();</span>

        <span class="c1">//find one token that matches</span>
        <span class="nx">Token</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="dl">"</span><span class="s2">token</span><span class="dl">"</span><span class="p">:</span> <span class="nx">token</span> <span class="p">})</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">token</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="c1">//if no entry was found that means the token was not in db</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
                        <span class="na">error</span><span class="p">:</span> <span class="p">{</span>
                            <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">token invalid</span><span class="dl">'</span>
                        <span class="p">}</span>
                    <span class="p">});</span>
                <span class="p">}</span>
                <span class="c1">//if token match, then verify validity and proceed to next</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">expiry</span> <span class="o">&gt;</span> <span class="nx">nowinMillis</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">return</span> <span class="nx">next</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">//if token is expired then delete it and respond with 403</span>
                    <span class="nx">User</span><span class="p">.</span><span class="nx">deleteOne</span><span class="p">({</span> <span class="dl">"</span><span class="s2">token</span><span class="dl">"</span><span class="p">:</span> <span class="nx">token</span> <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="dl">'</span><span class="s1">Error: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
                    <span class="p">})</span>
                        <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
                            <span class="na">error</span><span class="p">:</span> <span class="p">{</span>
                                <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">token expired, please create a new one</span><span class="dl">'</span>
                            <span class="p">}</span>
                        <span class="p">}));</span>
                <span class="p">}</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
                <span class="na">error</span><span class="p">:</span> <span class="p">{</span>
                    <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Auth Failed db error: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">err</span>
                <span class="p">}</span>
            <span class="p">}));</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//catch the errors that occur during parsing the authorization header</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
            <span class="na">error</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">authorization invalid</span><span class="dl">"</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="p">...</span>

<span class="c1">//export the two methods so it can be used</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">doAuth</span><span class="p">,</span> <span class="nx">createToken</span> <span class="p">};</span>
</pre></table></code></div></div><p>Now finally we can use the two methods in server.js:</p><h4 id="serverjs-1">server.js</h4><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1">//Use auth method as the middleware to do authentication</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">auth</span><span class="p">.</span><span class="nx">doAuth</span><span class="p">);</span>
<span class="p">....</span>

<span class="c1">//register auth endpoint</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/token</span><span class="dl">"</span><span class="p">,</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">createToken</span><span class="p">);</span>

<span class="p">....</span>
</pre></table></code></div></div><p>We can see the authentication in action by calling the apis:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://ik.imagekit.io/caveman96/assets/img/ECOM/token-auth_4kHP4_cogA.png" alt="Desktop View" /> <em>Generating a token</em></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://ik.imagekit.io/caveman96/assets/img/ECOM/token-valid_v2GbghKFfyau.png" alt="Desktop View" /> <em>Using the valid token</em></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://ik.imagekit.io/caveman96/assets/img/ECOM/token-expired_n644DwvaasP5.png" alt="Desktop View" /> <em>Using an expired token</em></p><h2 id="conclusion-and-whats-next">Conclusion and Whats next:</h2><p>We have managed to make a basic token based authentication for the server, while also learing about express middlewares. This is in no way a production ready implementation of token based authentication, we have a couple of problems. One is that we are storing the passwords as plain text in our db which is a major risk, this can be solved by hashing and salting the passwords before storing. Another one related to the token validation is that we have to make a db call to validate a token, this is not performant. What we need is a way for our server itself to validate the token. We can make use of JWT tokens and signatures to accomplish this.</p><p>Both of these will be addressed in upcoming posts, so stay tuned for those. Thanks for reading!!!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/backend/'>backend</a>, <a href='/categories/projects/'>projects</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/backend/" class="post-tag no-text-decoration" >backend</a> <a href="/tags/node/" class="post-tag no-text-decoration" >node</a> <a href="/tags/spring/" class="post-tag no-text-decoration" >spring</a> <a href="/tags/rest/" class="post-tag no-text-decoration" >rest</a> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a> <a href="/tags/projects/" class="post-tag no-text-decoration" >projects</a> <a href="/tags/javascript/" class="post-tag no-text-decoration" >javascript</a> <a href="/tags/express/" class="post-tag no-text-decoration" >express</a> <a href="/tags/authentication/" class="post-tag no-text-decoration" >authentication</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=E-COM 4- Credential based and token based authentication - Silesh.com&url=https://silesh.com/posts/ecom4-auth/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=E-COM 4- Credential based and token based authentication - Silesh.com&u=https://silesh.com/posts/ecom4-auth/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=E-COM 4- Credential based and token based authentication - Silesh.com&url=https://silesh.com/posts/ecom4-auth/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://silesh.com/posts/ecom4-auth/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/db01-key-value/">CAVEDB 1- Creating a key-value database in C++</a><li><a href="/posts/nQueens/">N Queens problem</a><li><a href="/posts/ecom3-restart/">E-COM 3- Regret, repent, and restart</a><li><a href="/posts/nosql-database/">What is a noSQL DB, and why you should use one.</a><li><a href="/posts/lru-cache-implementation/">LRU Cache implementation</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/backend/">backend</a> <a class="post-tag" href="/tags/projects/">projects</a> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/rest/">rest</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/express/">express</a> <a class="post-tag" href="/tags/interview/">interview</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/ecom3-restart/"><div class="card-body"> <span class="timeago small" > Jul 30 <i class="unloaded">2021-07-30T22:40:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>E-COM 3- Regret, repent, and restart</h3><div class="text-muted small"><p> I might have bitten of a lot more than I can chew by deciding to use MongoDB with Java. I have made the difficult decision to restart this project and build the backend in Node instead. I will elab...</p></div></div></a></div><div class="card"> <a href="/posts/ecom2-mongo/"><div class="card-body"> <span class="timeago small" > Jul 7 <i class="unloaded">2021-07-07T22:40:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>E-COM 2- Setting up MongoDB to use with Java and Spring</h3><div class="text-muted small"><p> This post will go over how to setup MongoDB (atlas) and move the storage of our product list over rather than keep it in memory. We will also see how to make use of spring repository to make crud o...</p></div></div></a></div><div class="card"> <a href="/posts/ecom1-spring/"><div class="card-body"> <span class="timeago small" > Jun 25 <i class="unloaded">2021-06-25T22:40:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>E-COM 1- Building a REST server and APIs with Java and Spring</h3><div class="text-muted small"><p> This post will serve as the starting point for a lot of big things to come. The plan is to incrementally develop a project (an e-commerece application) and experiment with and implement various ind...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/ecom3-restart/" class="btn btn-outline-primary" prompt="Older"><p>E-COM 3- Regret, repent, and restart</p></a> <a href="/posts/db01-key-value/" class="btn btn-outline-primary" prompt="Newer"><p>CAVEDB 1- Creating a key-value database in C++</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//silesh.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'E-COM 4- Credential based and token based authentication'; this.page.url = 'https://silesh.com/posts/ecom4-auth/'; this.page.identifier = '/posts/ecom4-auth/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#main > div.row:first-child > div:first-child img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/god_of_dummies">Silesh Chandran</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/backend/">backend</a> <a class="post-tag" href="/tags/projects/">projects</a> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/rest/">rest</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/express/">express</a> <a class="post-tag" href="/tags/interview/">interview</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://silesh.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
